<!DOCTYPE HTML>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout=http://www.ultraq.net.nz/thymeleaf/layout xmlns="http://www.w3.org/1999/html"
      layout:decorate="~{common/layout/layout}">
<body>
<div layout:fragment="content">
  <div class="category-bar">
    <!-- ì¹´í…Œê³ ë¦¬ ë§í¬ -->
    <a href="#HOME_ELECTRONICS">ê°€ì „ì œí’ˆ</a>
    <a href="#ELECTRONICS">ì „ìì œí’ˆ</a>
    <a href="#FASHION_MISCELLANEOUS">íŒ¨ì…˜ì˜ë¥˜/ì¡í™”</a>
    <a href="#BEAUTY">ë·°í‹°/ë¯¸ìš©</a>
    <a href="#INFANT_CHILDCARE">ì¶œì‚°/ìœ ì•„ë™</a>
    <a href="#FOOD">ì‹í’ˆ</a>
    <a href="#KITCHEN">ì£¼ë°©ìš©í’ˆ</a>
    <a href="#HOUSEHOLD">ìƒí™œìš©í’ˆ</a>
    <a href="#FURNITURE_INTERIOR">ê°€êµ¬/ì¸í…Œë¦¬ì–´</a>
    <a href="#SPORT_LEISURE">ìŠ¤í¬ì¸ /ë ˆì €</a>
    <a href="#CAR">ìë™ì°¨ìš©í’ˆ</a>
    <a href="#HOBBY_GAME_BOOK_ALBUM_DVD">ì·¨ë¯¸/ê²Œì„/ë„ì„œ/ìŒë°˜/DVD</a>
    <a href="#OFFICE_SUPPLIES">ë¬¸êµ¬/ì˜¤í”¼ìŠ¤</a>
    <a href="#PET">ë°˜ë ¤ë™ë¬¼ìš©í’ˆ</a>
    <a href="#ETC">ê¸°íƒ€ì¤‘ê³ ë¬¼í’ˆ</a>
  </div>
  <div class="post-container">
    <div th:each="postDto : ${postGetListResponseDto}" class="post-card"
         th:data-modified-time="${postDto.modifiedUpTime}">
      <a th:href="@{/posts/{postId}(postId=${postDto.postId})}">
        <div class="post-image-container">
          <img th:src="${postDto.imageUrl.get(0).toString}" alt="Post Image" class="post-image">
        </div>
        <h2 th:text="${postDto.title}" class="post-title"></h2>
        <div class="post-stats">
          <span class="view-count">ì¡°íšŒìˆ˜ <span th:text="${postDto.viewCnt}"></span></span>
          <span class="favorite-count">ì°œ <span th:text="${postDto.favoriteCnt}"></span></span>
          <span class="post-city"><span th:text="${postDto.city.getProvince.getName}"></span> / <span th:text="${postDto.city.getName}"></span></span>
          <span class="modified-date">ê²Œì‹œì¼: <span
              th:if="${#temporals.format(postDto.modifiedUpTime(), 'yyyyMMdd') == #temporals.format(#temporals.createNow(), 'yyyyMMdd')}"
              th:text="${#temporals.format(postDto.modifiedUpTime, 'HH:mm')}"></span>
          <span
              th:unless="${#temporals.format(postDto.modifiedUpTime(), 'yyyyMMdd') == #temporals.format(#temporals.createNow(), 'yyyyMMdd')}"
              th:text="${#temporals.format(postDto.modifiedUpTime, 'yyyy.MM.dd.')}"></span>
          </span>
        </div>
      </a>
      <button
          th:data-post-id="${postDto.postId}"
          onclick="toggleFavorite(this.getAttribute('data-post-id'))"
          th:text="${postDto.favoriteStatus} == true ? 'ğŸ’™' : 'ğŸ¤'"
          type="button"
      ></button>
      <div class="post-deal-status">
        <div th:if="${postDto.dealStatus == postDto.dealStatus.DEALING}" class="post-deal-status dealing"> ê±°ë˜ ì§„í–‰ ì¤‘ </div>
        <div th:if="${postDto.dealStatus == postDto.dealStatus.COMPLETED}" class="post-deal-status completed"> ê±°ë˜ ì™„ë£Œ </div>
      </div>
    </div>
  </div>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script th:inline="javascript">

    let isLoading = false;
    let lastModifiedTime = null; // ë§ˆì§€ë§‰ ê²Œì‹œë¬¼ ìˆ˜ì • ì‹œê°„ ì´ˆê¸°í™”
    let isLast = false;

    window.addEventListener("scroll", function () {

      const lastPost = document.querySelector('.post-card:last-of-type');
      if (lastPost) {
        const modifiedTime = lastPost.getAttribute('data-modified-time');
        if (modifiedTime) {
          lastModifiedTime = modifiedTime;
        }
      }

      const SCROLLED_HEIGHT = window.scrollY;
      const WINDOW_HEIGHT = window.innerHeight;
      const DOC_TOTAL_HEIGHT = document.body.offsetHeight;
      const IS_BOTTOM = (WINDOW_HEIGHT + SCROLLED_HEIGHT > DOC_TOTAL_HEIGHT);

      if (IS_BOTTOM && !isLoading) {
        loadMorePosts();
      }
    });

    function loadMorePosts() {
      isLoading = true;
      let url = '/search/posts/more?cursorTime=' + lastModifiedTime + '&';
      var searchValue = localStorage.getItem('searchValue') || '';
      var selectedCategory = localStorage.getItem('selectedCategory') || '';

      if (searchValue) {
        url += 'title=' + encodeURIComponent(searchValue);
      }
      if (selectedCategory) {
        url += (searchValue ? '&' : '') + 'category=' + encodeURIComponent(selectedCategory);
      }

      if(!isLast) {
        $.ajax({
          url: url,
          type: 'GET',
          success: function(htmlFragment) {
            $('.post-container').append(htmlFragment);
            updateLastModifiedTime(htmlFragment);
            isLoading = false;
          },
          error: function() {
            alert('ë” ì´ìƒ ë¡œë“œí•  ê²Œì‹œë¬¼ì´ ì—†ìŠµë‹ˆë‹¤.')
            isLast = true;
            isLoading = false;
          }
        });
      }
    }

    function updateLastModifiedTime(htmlFragment) {
      // HTML ì¡°ê°ì„ ì„ì‹œ ìš”ì†Œì— ì¶”ê°€í•˜ì—¬ íŒŒì‹±
      const tempDiv = document.createElement('div');
      tempDiv.innerHTML = htmlFragment;

      // ë§ˆì§€ë§‰ ê²Œì‹œë¬¼ì˜ ìˆ˜ì • ì‹œê°„ ì¶”ì¶œ
      const lastPost = tempDiv.querySelector('.post-card:last-of-type');
      if (lastPost) {
        const modifiedTime = lastPost.getAttribute('data-modified-time');
        if (modifiedTime) {
          lastModifiedTime = modifiedTime;
        }
      }
    }

    function toggleFavorite(postId) {
      $.ajax({
        url: '/posts/' + postId + '/favorite',
        type: 'PATCH',
        contentType: 'application/json; charset=utf-8',
        success: function() {
          location.reload()
        }
      });
    }
  </script>
</div>
</body>
</html>